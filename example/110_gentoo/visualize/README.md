# 7z-to-qdirstat for SquashFS

This Perl script converts the list output of `7z l` (specifically for SquashFS images) into a cache file readable by [QDirStat](https://github.com/shundhammer/qdirstat).

It allows you to visualize the **compressed** size, **uncompressed** size, or various **compression metrics** of files within a SquashFS image without mounting it.

The cache format is based on [qdirstat-cache-writer](https://github.com/shundhammer/qdirstat/blob/master/scripts/qdirstat-cache-writer).

## Usage

1. **Install Dependencies:**
   * Debian/Ubuntu: `apt install liburi-perl`
   * Gentoo: `emerge dev-perl/URI`

2. **Generate the Cache:**
   Pipe the output of `7z l` into the script using one of the modes below.

### Modes

#### 1. Compressed Size (Default)
Visualizes the actual space used on disk.
```bash
7z l image.squashfs | perl 7z-to-qdirstat.pl > image.cache
```

#### 2. Uncompressed Size
Visualizes the logical size of the files.
```bash
7z l image.squashfs | perl 7z-to-qdirstat.pl --uncompressed > image.cache
```

#### 3. Compression Ratio (`--ratio`)
Visualizes `(Compressed / Uncompressed) * 100`.
*   **Big Blocks:** Files that compressed poorly (Difficult to compress).
*   **Small Blocks:** Files that compressed well.
*   *Use this to find files that are stubborn and barely shrinking.*
```bash
7z l image.squashfs | perl 7z-to-qdirstat.pl --ratio > image.cache
```

#### 4. Compression Factor (`--factor`)
Visualizes `Uncompressed / Compressed`.
*   **Big Blocks:** Files that compressed extremely well (e.g., text logs, empty files).
*   **Small Blocks:** Files that compressed poorly.
*   *Use this to see "Space Saving Factor" (Inverse Ratio).*
```bash
7z l image.squashfs | perl 7z-to-qdirstat.pl --factor > image.cache
```

3. **Visualize:**
   Open QDirStat and select **File -> Open Cache File...**

## Limitations

*   **Solid Compression:** SquashFS usually uses solid compression. `7z` often reports `0` bytes or the uncompressed size for files inside a solid block because the metadata doesn't exist per-file.
*   **Summing Ratios:** When using `--ratio` or `--factor`, folder sizes represent the *sum* of the ratios of their children. This number is mathematically abstract, but the visual relative sizes of the individual file blocks are correct.

## Example

### Input (`7z l`)

```text
user@host ~ $ head -n 30 gentoo-7z-list.txt 

7-Zip (z) 25.01 (x64) : Copyright (c) 1999-2025 Igor Pavlov : 2025-08-03
 64-bit locale=C.UTF-8 Threads:32 OPEN_MAX:1024

Scanning the drive for archives:
1 file, 4267102208 bytes (4070 MiB)

Listing archive: /dev/shm/gentoo-z6-min_20251203/gentoo.squashfs

--
Path = /dev/shm/gentoo-z6-min_20251203/gentoo.squashfs
Type = SquashFS
Physical Size = 4267102208
Headers Size = 6222175
File System = SquashFS 4.0
Method = ZSTD
Cluster Size = 1048576
Big-endian = -
Created = 2025-12-03 03:41:46
Characteristics = DUPLICATES_REMOVED EXPORTABLE COMPRESSOR_OPTIONS
Code Page = UTF-8

   Date      Time    Attr         Size   Compressed  Name
------------------- ----- ------------ ------------  ------------------------
2025-11-24 06:24:18 .....            7            7  bin
2025-12-03 03:39:31 D....                            etc
2025-12-03 03:39:27 D....                            home
2025-12-01 01:01:03 .....          683            0  latest-stage3-amd64-nomultilib-systemd.txt
2025-11-24 06:24:15 .....            7            7  lib
2025-11-24 06:24:15 .....            9            9  lib64
```

### Output (QDirStat Cache)

```text
user@host ~ $ head -n 30 o.qdirstt 
[qdirstat 2.0 cache file]
# Generated by 7z-to-qdirstat
# Type  path  size  uid  gid  perm  mtime
D /squashfs-root        0       0       0       0755    0
F bin   7       0       0       0644    0
F latest-stage3-amd64-nomultilib-systemd.txt    0       0       0       0644    0
F lib   7       0       0       0644    0
F lib64 9       0       0       0644    0
F sbin  7       0       0       0644    0
F files,%2042307%20folders      299420  0       0       0644    0
D /squashfs-root/etc    0       0       0       0755    0
F ._cfg0000_hosts       208197  0       0       0644    0
F .pwd.lock     0       0       0       0644    0
F DIR_COLORS    0       0       0       0644    0
...
